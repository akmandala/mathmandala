<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Pico Multi-Serial Dashboard</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .device-box { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    button { margin-right: 10px; }
    pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h2>üß™ PicoDAQ Dashboard</h2>
  <button onclick="connectToDevices()">üîå Connect Devices</button>
  <div id="device-list"></div>

  <script>
    const FRAME_SIZE = 332;
    const FRAME_PAYLOAD_SIZE = 324;
    const devices = {};

    async function connectToDevices() {
      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 921600 });
        const serialNumber = `PICO${Object.keys(devices).length + 1}`;
        devices[serialNumber] = {
          port,
          buffer: new Uint8Array(),
          collecting: true,
          csvRows: [["Sequence Number", "Sample Index", "Sample Value"]],
          continuousSample: 0
        };
        setupDeviceUI(serialNumber);
        readFromPort(serialNumber);
      } catch (e) {
        alert("Error connecting: " + e);
      }
    }

    function setupDeviceUI(serialNumber) {
      const container = document.createElement('div');
      container.className = "device-box";
      container.id = `box-${serialNumber}`;

      container.innerHTML = `
        <h3>${serialNumber}</h3>
        <button onclick="toggleCollect('${serialNumber}')">‚èπ Stop</button>
        <button onclick="downloadCSV('${serialNumber}')">‚¨áÔ∏è Download CSV</button>
        <pre id="preview-${serialNumber}">No data yet</pre>
      `;
      document.getElementById("device-list").appendChild(container);
    }

    function toggleCollect(serial) {
      const dev = devices[serial];
      dev.collecting = !dev.collecting;
      const btn = document.querySelector(`#box-${serial} button`);
      btn.textContent = dev.collecting ? "‚èπ Stop" : "‚ñ∂Ô∏è Start";
    }

    function downloadCSV(serial) {
      const csv = devices[serial].csvRows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${serial}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function readFromPort(serial) {
      const dev = devices[serial];
      const reader = dev.port.readable.getReader();
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        if (value) {
          const combined = new Uint8Array(dev.buffer.length + value.length);
          combined.set(dev.buffer);
          combined.set(value, dev.buffer.length);
          dev.buffer = combined;

          while (dev.buffer.length >= FRAME_SIZE) {
            const frame = dev.buffer.slice(0, FRAME_SIZE);
            dev.buffer = dev.buffer.slice(FRAME_SIZE);
            processFrame(serial, frame);
          }
        }
      }
      reader.releaseLock();
    }

    function decodeSample24bit(bytes) {
      const val = (bytes[0] << 16) | (bytes[1] << 8) | bytes[2];
      return (bytes[0] & 0x80) ? val | 0xFF000000 : val;
    }

    function processFrame(serial, frame) {
      if (frame[0] !== 0xAA || frame[1] !== 0x55) return;
      const seq = (frame[2] << 8) | frame[3];
      const payload = frame.slice(6, 6 + FRAME_PAYLOAD_SIZE);
      const checksum = (frame[6 + FRAME_PAYLOAD_SIZE] << 8) | frame[7 + FRAME_PAYLOAD_SIZE];
      const sum = payload.reduce((acc, val) => acc + val, 0) & 0xFFFF;
      if (sum !== checksum) return;

      const dev = devices[serial];
      if (!dev.collecting) return;

      const preview = [];
      for (let i = 0; i < FRAME_PAYLOAD_SIZE; i += 3) {
        const sample = decodeSample24bit(payload.slice(i, i + 3));
        dev.csvRows.push([seq, dev.continuousSample, sample]);
        if (i < 30) preview.push(sample);
        dev.continuousSample++;
      }

      document.getElementById(`preview-${serial}`).textContent = "Preview:\n" + preview.join(", ");
    }
  </script>
</body>
</html>
